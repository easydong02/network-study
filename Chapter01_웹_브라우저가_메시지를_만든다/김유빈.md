# STORY 01 HTTP 리퀘스트 메시지를 작성한다

- 사용자가 브라우저에 URL 을 입력한 것을 해독하여 HTTP 요청 메시지를 생성하는 과정을 설명한다.

사용자는 원하는 기능을 수행하기 위해 브라우저의 주소창에 URL 을 입력합니다. URL 의 가장 앞단에 있는 프로토콜로 어느 성격의 서버에게 요청을 보낼 지 선택할 수 있습니다.

예를 들어, 웹 서버에게 요청을 보내기 위해서는 http 프로토콜을, 파일 서버에게 접근하기 위해서는 ftp 를 사용합니다. 프로토콜의 종류에 따라 이후에 오는 URL 의 정보가 달라집니다. 즉, 브라우저는 여러 성격의 서버에게 클라이언트 역할을 하며 어느 서버에게 요청을 보낼 지에 따라 필요한 정보가 다르기 때문에 이를 프로토콜로 구분합니다.

프로토콜을 이용하여 원하는 성격의 서버에 요청을 보낼 수 있습니다.

- 웹 서버 : http, https
- 파일 서버 : ftp
- 본인 PC 내 파일 접근 : file
- 메일 서버 : mailto
- 뉴스 서버 : news

웹 서버 요청 시 URL 은 다음과 같은 구조로 이루어져 있습니다.

`프로토콜:` + `//` + `웹 서버 명` + `/` + `디렉토리명` + `/` + … + `파일명`

URL 작성 시 파일명이 생략되어 있을 경우 서버 내 기본으로 설정되어 있는 파일 명으로 인식하며, 디렉토리명까지 생략되어 있을 경우 루트 경로로 판단합니다.

브라우저는 URL 의 구조에 따라 문자열을 파싱하여 다음과 같은 HTTP 요청 메시지를 생성합니다. 이 HTTP 요청 메시지를 원하는 서버에 전송하면 이를 해석하여 적절한 처리가 이루어집니다. HTTP 요청 메시지에는 서버에 정확히 어느 기능을 요청할 것인지에 대한 정보가 작성되어 있습니다.

```xml
# Request message
[Method] [URI] [HTTP version]
[field name] : [value]
...

[message]
```

HTTP 요청 메시지의 메서드(Method) 는 서버에 어떤 동작을 처리하고 싶은지 나타냅니다. 서버의 정보를 읽어오거나(GET), 생성 또는 수정(POST) 등의 동작을 명시합니다.

서버에서의 동작을 처리하면 서버는 클라이언트에게 HTTP 응답 메시지를 반환합니다. 이를 통해 서버의 동작이 제대로 처리되었는지 알 수 있습니다.

```xml
# Response message
[HTTP version] [status code] [message]
[field name] : [value]
...

[message]
```

응답 메시지의 앞 부분에 있는 status code 를 이용하여 실행 결과가 정상적으로 처리되었는지, 에러가 발생했는지 알 수 있습니다.

결과가 정상적으로 처리되어 브라우저에서 HTTP 응답 메시지를 수신하여 브라우저에 렌더링할 때, 영상이나 이미지 HTML 태그가 포함되어 있을 경우 서버에게 별도의 HTTP 요청 메시지를 전송하여 파일을 응답받습니다. 즉, HTTP 요청의 경우 하나의 요청에 하나의 응답만 받을 수 있으며, 이는 브라우저에서 판단하여 서버에게 요청을 보내는 방식으로 이루어집니다.

# STORY 02 웹 서버의 IP 주소를 DNS 서버에 조회한다

- 본격적으로 서버에 HTTP 메시지를 보내기 전, URL 의 도메인 주소를 IP 주소로 변환하는 과정을 설명한다.

TCP/IP 는 서브넷이라는 작은 네트워크를 라우터로 연결하여 전체 네트워크가 구성되는 방식입니다. 서브넷이란, 전체 네트워크에서 일부 작은 네트워크를 의미합니다. 여러 개의 서브넷을 라우터로 연결하면 네트워크 전체가 구성됩니다.

IP 주소는 기기의 주소와 같은 역할을 하며, 32비트의 숫자로 이루어져 있습니다. IP 는 서브넷 영역과 서브넷 내의 호스트 영역으로 구분되어 있는데, 이 영역은 정해져 있지 않습니다. 서브넷 영역을 구분하기 위해 어느 영역까지가 서브넷 영역인지 나타내는 것을 ‘넷마스크’ 라고 합니다.

`10.11.12.13/24` → 24가 넷마스크

24는 넷마스크의 1의 개수입니다. 넷마스크를 나열하면 다음과 같은 형태를 띕니다.

`11111111.11111111.11111111.00000000`

즉, 위의 IP 주소에서 10.11.12 까지가 서브넷 영역이며 13이 호스트 영역임을 알 수 있습니다.

호스트 영역의 모든 비트가 1인 경우 서브넷의 모든 기기에게 패킷을 보내는 브로드 캐스트를 의미합니다.

`10.11.12.255`

브라우저는 URL 을 해독하여 정해진 규칙에 따라 HTTP 메시지를 생성하지만 이를 서버에게 전송하는 기능이 없어, HTTP 메시지를 네트워크에 송출하기 위해 OS 에게 송신을 의뢰합니다. 다만, OS 는 네트워크 통신 시 도메인 주소가 아닌 IP 주소를 필요로 합니다. 따라서, OS 에 송신을 의뢰하기 전 사용자가 입력한 도메인 주소를 IP 주소로 변환하는 과정이 필요하며 해당 정보를 얻기 위해 DNS 서버에 접근해야 합니다.

결국 DNS 서버도 웹 서버처럼 서버일 뿐이며 통신하기 위해서는 요청 과정을 거쳐야합니다. 어플리케이션(ex. 브라우저) 에서 지원하는 소켓 라이브러리를 이용하여 DNS 서버에게 요청을 보낼 수 있습니다. 소켓 라이브러리의 API 를 이용하여 IP 주소를 응답받으면 이를 이용하여 OS 에게 실제로 보내고자 했던 서버에게 요청을 보내도록 의뢰할 수 있습니다.

DNS 서버에게 IP 주소를 받아오는 과정은 다음과 같습니다.

- 네트워크 어플리케이션에서 Socket 라이브러리 실행
- Socket 라이브러리의 gethostbyname(C언어 기준) API 를 호출하여 OS 의 프로토콜 스택에게 의뢰합니다.
    - DNS 서버에게 별도의 요청을 보내야 하기 때문에 마찬가지로 OS 에게 네트워크 통신을 의뢰합니다.
    - DNS 서버에게 요청 시에도 IP 주소로 요청해야하며, 해당 PC 의 기본 IP 주소를 설정할 수 있습니다.
- OS 의 프로토콜 스택은 DNS 서버에게 메시지를 전송하여 IP 를 받아옵니다.

받아온 IP 를 이용하여 다시 OS 에게 네트워크 통신을 의뢰하면 원하는 서버에게 요청을 보낼 수 있습니다.
